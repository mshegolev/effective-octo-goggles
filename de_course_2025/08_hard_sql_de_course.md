# Data Engineering ‚Äî –†–∞–∑–¥–µ–ª 8. Hard SQL –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç

**–ê–≤—Ç–æ—Ä:** –©–µ–≥–æ–ª–µ–≤ –ú–∏—Ö–∞–∏–ª  
**–ö—É—Ä—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, 2025**

---

## üìò –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–¥–∞—á–∏](#–≤–≤–µ–¥–µ–Ω–∏–µ-–≤-—Å–ª–æ–∂–Ω—ã–µ-sql-–∑–∞–¥–∞—á–∏)
2. [CTE, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã](#cte-–æ–∫–æ–Ω–Ω—ã–µ-—Ñ—É–Ω–∫—Ü–∏–∏-–∏-–ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã)
3. [–ü—Ä–∞–∫—Ç–∏–∫–∞ –Ω–∞ StrataScratch](#–ø—Ä–∞–∫—Ç–∏–∫–∞-–Ω–∞-stratascratch)
4. [–ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#–º–∏–Ω–∏–ø—Ä–æ–µ–∫—Ç-–∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
5. [–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏](#–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ-–≤–æ–ø—Ä–æ—Å—ã-–∏-gpt–ø–æ–¥—Å–∫–∞–∑–∫–∏)

---

## –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–¥–∞—á–∏

üîπ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª –∫—É—Ä—Å–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π SQL –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —Ä–µ–∞–ª—å–Ω—ã–º –∑–∞–¥–∞—á–∞–º –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è–º Data Engineer.

üìò –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏: [StrataScratch](https://www.stratascratch.com/)

üí° *–°–æ–≤–µ—Ç:* —Ä–µ—à–∞–π –∑–∞–¥–∞—á–∏ —É—Ä–æ–≤–Ω—è **Medium ‚Üí Hard**, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—è —Ä–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã (JOIN, CTE, –æ–∫–æ–Ω–∫–∏, –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã).

---

## CTE, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã

### üß† –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- **CTE (Common Table Expression)** –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–±–∏–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏.  
- **–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.  
- **–ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã** –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

### üíª –ü—Ä–∏–º–µ—Ä CTE + –æ–∫–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

```sql
WITH revenue_cte AS (
    SELECT user_id,
           SUM(amount) AS total_revenue
    FROM purchases
    GROUP BY user_id
)
SELECT user_id,
       total_revenue,
       RANK() OVER (ORDER BY total_revenue DESC) AS rank
FROM revenue_cte
WHERE total_revenue > 1000;
```

üí° *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* —Ç–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å –∏—â–µ—Ç —Å–∞–º—ã—Ö –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –∏–º —Ä–µ–π—Ç–∏–Ω–≥.

### üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ CTE –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.  
> –ü—Ä–∏–¥—É–º–∞–π –∑–∞–¥–∞—á—É –Ω–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤.

---

## –ü—Ä–∞–∫—Ç–∏–∫–∞ –Ω–∞ StrataScratch

### üß† –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–∞–¥–∞—á–∏
1. **Airbnb: Host Popularity Rental Prices**  
   ‚Üí –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã.
2. **Amazon: Top 3 Salaries by Department**  
   ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `DENSE_RANK()` –∏ `PARTITION BY`.
3. **Uber: Trips and Users**  
   ‚Üí –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è.
4. **Spotify: Top Artists by Stream Count**  
   ‚Üí –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.
5. **Netflix: Retention Analysis**  
   ‚Üí –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º.

üí° *–°–æ–≤–µ—Ç:* —Ä–µ—à–∞–π –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É –º–∏–Ω–∏–º—É–º –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:
- —á–µ—Ä–µ–∑ `JOIN` –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏,
- —á–µ—Ä–µ–∑ `CTE` –∏ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

### üíª –ü—Ä–∏–º–µ—Ä: Top 3 –∑–∞—Ä–ø–ª–∞—Ç—ã –ø–æ –æ—Ç–¥–µ–ª–∞–º

```sql
SELECT department,
       employee,
       salary
FROM (
    SELECT department,
           employee,
           salary,
           DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rnk
    FROM employees
) ranked
WHERE rnk <= 3;
```

üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –ü–æ–ø—Ä–æ—Å–∏ GPT –æ–±—ä—è—Å–Ω–∏—Ç—å, –∫–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞—Ä–ø–ª–∞—Ç—ã.  
> –ü—Ä–∏–¥—É–º–∞–π –∑–∞–¥–∞—á—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ CTE –∏ –æ–∫–æ–Ω–∫–∞–º–∏.

---

## –ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üéØ –¶–µ–ª—å
–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π SQL-–æ—Ç—á—ë—Ç, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –≤—Å–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:
- –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏,
- CTE,
- –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã,
- –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è.

### üìã –ò—Å—Ö–æ–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- **users** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (id, name, country, reg_date)  
- **sessions** ‚Äî —Å–µ—Å—Å–∏–∏ (user_id, start_time, duration)  
- **purchases** ‚Äî –ø–æ–∫—É–ø–∫–∏ (user_id, amount, purchase_date)

### üíª –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞

```sql
WITH active_users AS (
    SELECT user_id,
           COUNT(*) AS session_count,
           SUM(duration) AS total_time
    FROM sessions
    WHERE start_time >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY user_id
),
user_revenue AS (
    SELECT user_id,
           SUM(amount) AS revenue
    FROM purchases
    WHERE purchase_date >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY user_id
)
SELECT u.name,
       u.country,
       a.session_count,
       a.total_time,
       r.revenue,
       ROUND(r.revenue / NULLIF(a.session_count, 0), 2) AS avg_revenue_per_session
FROM users u
LEFT JOIN active_users a ON u.id = a.user_id
LEFT JOIN user_revenue r ON u.id = r.user_id
ORDER BY r.revenue DESC NULLS LAST;
```

üí° *–ò–¥–µ—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:*
- –¥–æ–±–∞–≤–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç—Ä–∞–Ω–∞–º,  
- –≤–∫–ª—é—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ retention,  
- —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É –≤ ClickHouse –∏–ª–∏ DWH.

### üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –ü–æ–ø—Ä–æ—Å–∏ GPT: ¬´–ü–æ–º–æ–≥–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è PostgreSQL –∏–ª–∏ ClickHouse¬ª.  
> ¬´–î–æ–±–∞–≤—å –≤ –∑–∞–ø—Ä–æ—Å –∫–æ–ª–æ–Ω–∫—É retention –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º¬ª.

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏

1. –ß—Ç–æ —Ç–∞–∫–æ–µ CTE –∏ –∑–∞—á–µ–º –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?  
2. –ß–µ–º –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏—Ö?  
3. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `RANK()` –∏ `DENSE_RANK()`?  
4. –ö–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ CTE –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?  
5. –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã?  
6. –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —É–¥–æ–±–Ω–æ —Ä–µ—à–∞—Ç—å —á–µ—Ä–µ–∑ StrataScratch?

üí° *–°–æ–≤–µ—Ç:* –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî —Å–ø—Ä–æ—Å–∏ GPT:
> ¬´–ü—Ä–∏–¥—É–º–∞–π —Å–ª–æ–∂–Ω—É—é SQL-–∑–∞–¥–∞—á—É –Ω–∞ —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏¬ª  
> ¬´–ü–æ–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞ —Å CTE¬ª

---

‚úÖ **–ò—Ç–æ–≥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:**  
- –¢—ã —É–≤–µ—Ä–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –æ–∫–æ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏, CTE –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏.  
- –£–º–µ–µ—à—å —Ä–µ—à–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–¥–∞—á–∏ —É—Ä–æ–≤–Ω—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è.  
- –ì–æ—Ç–æ–≤ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≤–∏—Ç—Ä–∏–Ω –∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤.