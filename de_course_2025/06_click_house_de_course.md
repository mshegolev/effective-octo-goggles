# Data Engineering ‚Äî –†–∞–∑–¥–µ–ª 6. ClickHouse

**–ê–≤—Ç–æ—Ä:** –©–µ–≥–æ–ª–µ–≤ –ú–∏—Ö–∞–∏–ª  
**–ö—É—Ä—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, 2025**

---

## üìò –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ –≤ ClickHouse](#–≤–≤–µ–¥–µ–Ω–∏–µ-–≤-clickhouse)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏-—Ö—Ä–∞–Ω–µ–Ω–∏–µ-–¥–∞–Ω–Ω—ã—Ö)
3. [–î–≤–∏–∂–∫–∏ —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å—ã](#–¥–≤–∏–∂–∫–∏-—Ç–∞–±–ª–∏—Ü-–∏-–∏–Ω–¥–µ–∫—Å—ã)
4. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤](#–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–∑–∞–ø—Ä–æ—Å–æ–≤)
5. [–ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ –ø—Ä–æ–¥–∞–∂](#–º–∏–Ω–∏–ø—Ä–æ–µ–∫—Ç-–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è-–≤–∏—Ç—Ä–∏–Ω–∞-–ø—Ä–æ–¥–∞–∂)
6. [–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏](#–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ-–≤–æ–ø—Ä–æ—Å—ã-–∏-gpt–ø–æ–¥—Å–∫–∞–∑–∫–∏)

---

## –í–≤–µ–¥–µ–Ω–∏–µ –≤ ClickHouse

üìò –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: *ClickHouse ‚Äî Google Docs*, *Index ‚Äî Roadmappers*

### üß† –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è
ClickHouse ‚Äî –∫–æ–ª–æ–Ω–æ—á–Ω–∞—è –°–£–ë–î –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.  
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–π –ø–æ –±–æ–ª—å—à–∏–º –æ–±—ä—ë–º–∞–º –¥–∞–Ω–Ω—ã—Ö.

### üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- –í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–π.
- –°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö (–≤ 5‚Äì10 —Ä–∞–∑).
- –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MPP (Massively Parallel Processing).

üí° *–°–æ–≤–µ—Ç:* ClickHouse –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ø–Ω–¥–µ–∫—Å–µ, –°–±–µ—Ä–µ, VK, Avito –∏ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏ –ª–æ–≥–æ–≤.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### üß† –ü—Ä–∏–Ω—Ü–∏–ø —Ö—Ä–∞–Ω–µ–Ω–∏—è
- –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ **—Å—Ç–æ–ª–±—Ü–∞–º**, –∞ –Ω–µ –ø–æ —Å—Ç—Ä–æ–∫–∞–º.  
- –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –∞–≥—Ä–µ–≥–∞—Ç—ã (`SUM`, `AVG`, `COUNT`) –∏ —ç–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å.  
- –ö–∞–∂–¥—ã–π —Å—Ç–æ–ª–±–µ—Ü —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ –Ω–∞ –¥–∏—Å–∫–µ.

### üíª –ü—Ä–∏–º–µ—Ä

```sql
CREATE TABLE sales (
    date Date,
    region String,
    product String,
    amount Float32
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (region, product);
```

üí° *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º –∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ region + product.

### üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É ClickHouse –±—ã—Å—Ç—Ä–µ–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö row-based –±–∞–∑.  
> –ü—Ä–∏–¥—É–º–∞–π –∑–∞–¥–∞—á—É, –≥–¥–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–∫–æ—Ä–∏—Ç –∑–∞–ø—Ä–æ—Å.

---

## –î–≤–∏–∂–∫–∏ —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å—ã

### üß† –û—Å–Ω–æ–≤–Ω—ã–µ –¥–≤–∏–∂–∫–∏
- **MergeTree** ‚Äî –±–∞–∑–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–Ω–¥–µ–∫—Å–æ–≤, –ø–∞—Ä—Ç–∏—Ü–∏–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.  
- **SummingMergeTree** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—É–º–º–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è –ø—Ä–∏ –º—ë—Ä–∂–µ.  
- **AggregatingMergeTree** ‚Äî —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–µ–¥–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.  
- **ReplacingMergeTree** ‚Äî –∑–∞–º–µ–Ω—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∫–ª—é—á—É.

### üíª –ü—Ä–∏–º–µ—Ä—ã

```sql
-- SummingMergeTree
CREATE TABLE sales_summary (
    region String,
    category String,
    total_amount Float64
)
ENGINE = SummingMergeTree()
ORDER BY (region, category);

-- ReplacingMergeTree
CREATE TABLE user_data (
    user_id UInt64,
    name String,
    updated_at DateTime
)
ENGINE = ReplacingMergeTree(updated_at)
ORDER BY user_id;
```

### üí° –ò–Ω–¥–µ–∫—Å—ã
ClickHouse –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **primary key** –∫–∞–∫ *skip index* ‚Äî –æ–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é.

üí° *–°–æ–≤–µ—Ç:* –í—Ç–æ—Ä–∏—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ø—Ä–∏–≤—ã—á–Ω–æ–º –≤–∏–¥–µ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å *data skipping indexes* (minmax, bloom filter).

### üíª –ü—Ä–∏–º–µ—Ä skip –∏–Ω–¥–µ–∫—Å–∞

```sql
CREATE TABLE metrics (
    event_date Date,
    user_id UInt32,
    value Float32
)
ENGINE = MergeTree()
ORDER BY (event_date, user_id)
SETTINGS index_granularity = 8192;
```

### üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç skip index.  
> –ü—Ä–∏–¥—É–º–∞–π –ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AggregatingMergeTree.

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### üß† –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—ë–º—ã
1. –ò—Å–ø–æ–ª—å–∑—É–π `LIMIT` –ø—Ä–∏ —Ç–µ—Å—Ç–∞—Ö.  
2. –ü—Ä–∏–º–µ–Ω—è–π `PREWHERE` –≤–º–µ—Å—Ç–æ `WHERE` (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ).  
3. –§–∏–ª—å—Ç—Ä—É–π –ø–æ –∫–ª—é—á–∞–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (`ORDER BY`).  
4. –†–∞–∑–¥–µ–ª—è–π –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º (`PARTITION BY`).  
5. –ò—Å–ø–æ–ª—å–∑—É–π `sample` –∏ `TTL` –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

### üíª –ü—Ä–∏–º–µ—Ä

```sql
SELECT region, SUM(amount) AS total
FROM sales
WHERE date >= '2025-01-01' AND date < '2025-02-01'
GROUP BY region
ORDER BY total DESC
LIMIT 10;
```

üí° *–°–æ–≤–µ—Ç:* –≤—Å–µ–≥–¥–∞ —Å–º–æ—Ç—Ä–∏ `EXPLAIN` ‚Äî –æ–Ω –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∏ –∏–Ω–¥–µ–∫—Å—ã –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã.

### üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç PREWHERE.  
> –ö–∞–∫ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é –ø–æ –±–æ–ª—å—à–∏–º —Ç–∞–±–ª–∏—Ü–∞–º?

---

## –ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ –ø—Ä–æ–¥–∞–∂

### üéØ –¶–µ–ª—å
–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≤–∏—Ç—Ä–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ClickHouse –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

### üìã –ó–∞–¥–∞—á–∏
1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `sales_raw` (–∏—Å—Ç–æ—á–Ω–∏–∫).  
2. –°–æ–∑–¥–∞—Ç—å –∞–≥—Ä–µ–≥–∏—Ä—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É `sales_agg` –Ω–∞ SummingMergeTree.  
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π insert –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.  
4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã.

### üíª –ü—Ä–∏–º–µ—Ä

```sql
CREATE TABLE sales_raw (
    sale_id UInt64,
    date Date,
    region String,
    category String,
    amount Float32
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (region, category);

CREATE MATERIALIZED VIEW sales_agg_mv
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (region, category)
AS
SELECT region, category, SUM(amount) AS total
FROM sales_raw
GROUP BY region, category;
```

### üí° GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏
> –ü–æ–ø—Ä–æ—Å–∏ GPT –Ω–∞–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂ –∑–∞ –¥–≤–∞ –ø–µ—Ä–∏–æ–¥–∞.  
> –ü—Ä–∏–¥—É–º–∞–π, –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å SCD2-–ª–æ–≥–∏–∫—É –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ ClickHouse.

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏

1. –ö–∞–∫ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –≤ ClickHouse?  
2. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –¥–≤–∏–∂–æ–∫ MergeTree?  
3. –í —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É SummingMergeTree –∏ AggregatingMergeTree?  
4. –ß—Ç–æ —Ç–∞–∫–æ–µ skip index –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç?  
5. –ß–µ–º PREWHERE –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç WHERE?  
6. –ü–æ—á–µ–º—É ClickHouse –±—ã—Å—Ç—Ä–µ–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –°–£–ë–î –ø—Ä–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ?

üí° *–°–æ–≤–µ—Ç:* –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî —Å–ø—Ä–æ—Å–∏ GPT:
> ¬´–û–±—ä—è—Å–Ω–∏, –∫–∞–∫ ClickHouse —É—Å–∫–æ—Ä—è–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã¬ª  
> ¬´–ü–æ–º–æ–≥–∏ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse –ø–æ–¥ e-commerce¬ª

---

‚úÖ **–ò—Ç–æ–≥ —Ä–∞–∑–¥–µ–ª–∞:**  
- –ü–æ–Ω–∏–º–∞–µ—à—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –¥–≤–∏–∂–∫–∏ ClickHouse.  
- –£–º–µ–µ—à—å –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –≤–∏—Ç—Ä–∏–Ω—ã.  
- –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —Å –æ–±—ä–µ–∫—Ç–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ S3.
